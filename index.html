<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>××¢×¨×›×ª ×œ×•×– ×¨×›×‘×™× ××©×¤×—×ª×™×ª</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        .dashboard {
            background: white;
            padding: 20px;
            border-radius: 16px;
            width: 100%;
            max-width: 1000px;
            margin: 20px 0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            overflow-x: auto;
        }

        .form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .form input,
        .form select {
            padding: 10px;
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid #ccc;
            flex: 1 1 100px;
        }

        .form button {
            background: #4facfe;
            color: white;
            border: none;
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            flex: 1 1 80px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        th {
            background: #f0f0f0;
            font-weight: 600;
        }

        .save {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background: #00c853;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .admin {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        #weeklySystem {
            margin-top: 20px;
            overflow-x: auto;
        }

        .system-table {
            border-collapse: collapse;
            width: 100%;
            max-width: 1000px;
            font-size: 14px;
        }

        .system-table th,
        .system-table td {
            border: 1px solid #333;
            padding: 10px;
            min-width: 100px;
            text-align: center;
            white-space: nowrap;
        }

        .system-table th {
            background: #bbdefb;
            font-weight: 700;
            font-size: 16px;
        }

        .time-cell {
            background: #eeeeee;
            font-weight: bold;
        }

        .editable {
            cursor: text;
            background: #fafafa;
        }

        .editable.editing {
            background: #fff9c4;
            outline: 2px solid #ffeb3b;
        }

        /* --- ×¨×¡×¤×•× ×¡×™×‘×™×•×ª --- */
        @media (max-width: 600px) {
            .form {
                flex-direction: column;
            }

            .form input, .form select, .form button {
                flex: 1 1 100%;
            }

            .system-table th,
            .system-table td {
                min-width: 80px;
                padding: 6px;
                font-size: 12px;
            }

            th {
                font-size: 12px;
            }

            table, .system-table {
                font-size: 12px;
            }

            .save, .admin {
                font-size: 14px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>

<div class="dashboard">
    <h1 id="welcome"></h1>
    <h2>×”×œ×•×´×– ×”×©×‘×•×¢×™ ×©×œ×™</h2>

    <div class="form">
        <select id="day">
            <option value="">×‘×—×¨ ×™×•×</option>
            <option value="×¨××©×•×Ÿ">×¨××©×•×Ÿ</option>
            <option value="×©× ×™">×©× ×™</option>
            <option value="×©×œ×™×©×™">×©×œ×™×©×™</option>
            <option value="×¨×‘×™×¢×™">×¨×‘×™×¢×™</option>
            <option value="×—××™×©×™">×—××™×©×™</option>
            <option value="×©×™×©×™">×©×™×©×™</option>
            <option value="×©×‘×ª">×©×‘×ª</option>
        </select>

        <input id="start" placeholder="×”×ª×—×œ×”">
        <input id="end" placeholder="×¡×™×•×">
        <input type="text" id="activity" placeholder="××” ×”×¤×¢×™×œ×•×ª?">

        <button onclick="addActivity()">â• ×”×•×¡×£</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>×™×•×</th>
                <th>×”×ª×—×œ×”</th>
                <th>×¡×™×•×</th>
                <th>×¤×¢×™×œ×•×ª</th>
                <th>××—×™×§×”</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <button class="save" onclick="saveSchedule()">ğŸ’¾ ×©××™×¨×”</button>
    <button id="adminBtn" class="admin" onclick="generateWeeklyTableFinal()">
        ğŸ›  ×™×¦×™×¨×ª ××¢×¨×›×ª ×©×‘×•×¢×™×ª
    </button>

    <div id="weeklySystem" style="display:none;">
        <h2>××¢×¨×›×ª ×¨×›×‘×™× ×©×‘×•×¢×™×ª</h2>
        <div class="table-wrapper">
            <div id="systemTable"></div>
        </div>
    </div>
</div>

<!-- Firebase + Flatpickr -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
import flatpickr from "https://cdn.jsdelivr.net/npm/flatpickr";

const firebaseConfig = {
  apiKey: "AIzaSyC9PTX8tvzhUf1BXW5ZeNbeKJcSF91sNjU",
  authDomain: "family-cars-scheduler.firebaseapp.com",
  databaseURL: "https://family-cars-scheduler-default-rtdb.firebaseio.com",
  projectId: "family-cars-scheduler",
  storageBucket: "family-cars-scheduler.firebasestorage.app",
  messagingSenderId: "646138637773",
  appId: "1:646138637773:web:12932dc39f54c0b803e884"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- ××©×ª××© ---
let username = prompt("×”×›× ×¡ ×©× ××©×ª××©: ×××, ××™×ª×™, ×©× ×™, ××•×¨×™, ××‘×") || "××™×ª×™";
document.getElementById("welcome").textContent = `×©×œ×•× ${username} ğŸ‘‹`;
if (username !== "××™×ª×™") document.getElementById("adminBtn").style.display="none";

let activities = [];
const daysOrder = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
const cars = ["×××–×“×” ×œ×‘× ×”","×××–×“×” ×›×—×•×œ×”","×˜×•×™×•×˜×” (××‘×)","××•×˜×•×‘×•×¡"];

const dayInput = v => { const el = document.getElementById("day"); if(v!==undefined) el.value=v; return el.value; };
const startInput = v => { const el = document.getElementById("start"); if(v!==undefined) el.value=v; return el.value; };
const endInput = v => { const el = document.getElementById("end"); if(v!==undefined) el.value=v; return el.value; };
const activityInput = v => { const el = document.getElementById("activity"); if(v!==undefined) el.value=v; return el.value; };

function clearForm() {
    document.getElementById("day").value="";
    document.getElementById("start").value="";
    document.getElementById("end").value="";
    document.getElementById("activity").value="";
}

// --- Flatpickr ×œ×’×œ×’×œ×•×ª ×©×¢×” ---
flatpickr("#start", { enableTime: true, noCalendar: true, dateFormat: "H:i" });
flatpickr("#end", { enableTime: true, noCalendar: true, dateFormat: "H:i" });

// --- ×œ×•×– ××™×©×™ ×¢× ×•×œ×™×“×¦×™×” ---
function addActivity() {
    const day = dayInput();
    const start = startInput();
    const end = endInput();
    const activity = activityInput();

    if (!day || !start || !end || !activity) {
        alert("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª");
        return;
    }

    // ×•×œ×™×“×¦×™×”: ×”×ª×—×œ×” < ×¡×™×•×
    if (start >= end) {
        alert("×©×¢×ª ×”×”×ª×—×œ×” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤× ×™ ×©×¢×ª ×”×¡×™×•× â°");
        return;
    }

    // ×•×œ×™×“×¦×™×”: ××™×Ÿ ×—×¤×™×¤×” ×¢× ×¤×¢×™×œ×•×™×•×ª ×§×™×™××•×ª
    const dayActivities = activities.filter(a => a.day === day);
    const overlap = dayActivities.some(a => !(end <= a.start || start >= a.end));
    if (overlap) {
        alert("×”×˜×•×•×— ×©×”×›× ×¡×ª ×—×•×¤×£ ×œ×¤×¢×™×œ×•×ª ×§×™×™××ª ×‘××•×ª×• ×™×•× âŒ");
        return;
    }

    activities.push({ username, day, start, end, activity });
    sortActivities();
    renderTable();
    clearForm();
}

function sortActivities() { 
    activities.sort((a,b)=> daysOrder.indexOf(a.day)-daysOrder.indexOf(b.day)||a.start.localeCompare(b.start)); 
}

function renderTable() {
    const tbody = document.getElementById("tableBody"); 
    tbody.innerHTML="";
    activities.forEach((a,i)=>tbody.innerHTML+=`<tr>
        <td>${a.day}</td><td>${a.start}</td><td>${a.end}</td><td>${a.activity}</td>
        <td><button onclick="deleteActivity(${i})">âŒ</button></td>
    </tr>`);
}

function deleteActivity(i){ 
    if(!confirm("×œ××—×•×§ ××ª ×”×¤×¢×™×œ×•×ª?")) return; 
    activities.splice(i,1); 
    renderTable(); 
}

// --- Firebase ---
function saveSchedule() {
    set(ref(db, `schedules/${username}`), activities)
        .then(()=>alert("×”×œ×•×´×– × ×©××¨ ×‘×”×¦×œ×—×” âœ…"))
        .catch(()=>alert("×©×’×™××” ×‘×©××™×¨×ª ×”×œ×•×´×– âŒ"));
}

function loadUserSchedule() {
    get(ref(db, `schedules/${username}`)).then(snapshot=>{
        activities = snapshot.val() || [];
        sortActivities();
        renderTable(); // <--- ××¦×™×’ ××ª ×”×œ×•×– ××™×“
    }).catch(err => console.error("×©×’×™××” ×‘×˜×¢×™× ×ª ×”×œ×•×´×–:", err));
}

// ×˜×¢×™× ×” ××™×“×™×ª ×¢× ×›× ×™×¡×”
loadUserSchedule();

async function loadAllSchedules() {
    const snapshot = await get(ref(db,"schedules")); 
    if(!snapshot.exists()) return [];
    return Object.values(snapshot.val()).flat();
}

function enableEditing() {
    document.querySelectorAll(".editable").forEach(cell=>{
        cell.addEventListener("focus",()=>cell.classList.add("editing"));
        cell.addEventListener("blur",()=>cell.classList.remove("editing"));
    });
}

async function generateWeeklyTableFinal() {
    const personalSchedules = await loadAllSchedules();
    document.getElementById("weeklySystem").style.display="block";
    let html=`<table class="system-table"><tr><th>×™×•×</th><th>×©×¢×•×ª</th>`; 
    cars.forEach(c=>html+=`<th>${c}</th>`); 
    html+=`</tr>`;

    for(let day of daysOrder){
        const requests = personalSchedules.filter(r=>r.day===day);
        if(!requests.length) continue;
        let intervals=[];
        requests.forEach(r=>{
            let added=false;
            for(let interval of intervals){
                if(!(r.end<=interval.start||r.start>=interval.end)){
                    interval.start=r.start<interval.start?r.start:interval.start;
                    interval.end=r.end>interval.end?r.end:interval.end;
                    interval.requests.push(r); added=true; break;
                }
            }
            if(!added) intervals.push({start:r.start,end:r.end,requests:[r]});
        });

        intervals.forEach((interval,idx)=>{
            html+=`<tr>`; if(idx===0) html+=`<td class="time-cell" rowspan="${intervals.length}">${day}</td>`;
            html+=`<td class="time-cell">${interval.start}-${interval.end}</td>`;
            const assigned={}; const assignedUsers=new Set();
            const bluePriority=["×××","××™×ª×™","××•×¨×™"];
            const blueUser=bluePriority.find(u=>interval.requests.some(r=>r.username===u)&&!assignedUsers.has(u));
            assigned["×××–×“×” ×›×—×•×œ×”"]=blueUser?[blueUser]:[]; if(blueUser) assignedUsers.add(blueUser);

            let whiteUser=null;
            const itiAssignedBlue=assignedUsers.has("××™×ª×™");
            const shani=interval.requests.find(r=>r.username==="×©× ×™");
            const iti=interval.requests.find(r=>r.username==="××™×ª×™");
            if(shani){ if(itiAssignedBlue) whiteUser="×©× ×™";
            else{ const shaniImportant=["×¢×‘×•×“×”","×œ×™××•×“×™×"].some(act=>shani.activity.toLowerCase().includes(act));
            const itiImportant=iti?["×¢×‘×•×“×”","×œ×™××•×“×™×"].some(act=>iti.activity.toLowerCase().includes(act)):false;
            if(shaniImportant||(!shaniImportant&&!itiImportant)) whiteUser="×©× ×™";
            else if(itiImportant) whiteUser="××™×ª×™"; }}
            else if(iti) whiteUser="××™×ª×™";

            if(whiteUser){ assigned["×××–×“×” ×œ×‘× ×”"]=[whiteUser]; assignedUsers.add(whiteUser);} else assigned["×××–×“×” ×œ×‘× ×”"]=[];

            if(interval.requests.some(r=>r.username==="××‘×")&&!assignedUsers.has("××‘×")){ assigned["×˜×•×™×•×˜×” (××‘×)"]=["××‘×"]; assignedUsers.add("××‘×"); } else assigned["×˜×•×™×•×˜×” (××‘×)"]=[];

            assigned["××•×˜×•×‘×•×¡"]=interval.requests.map(r=>r.username).filter(u=>!assignedUsers.has(u));
            cars.forEach(c=>html+=`<td class="editable" contenteditable="true">${assigned[c].join(", ")}</td>`);
            html+=`</tr>`;
        });
    }

    html+=`</table>`; document.getElementById("systemTable").innerHTML=html; enableEditing();
}

// --- ×—×©×™×¤×” ×’×œ×•×‘×œ×™×ª ---
window.addActivity=addActivity;
window.deleteActivity=deleteActivity;
window.saveSchedule=saveSchedule;
window.generateWeeklyTableFinal=generateWeeklyTableFinal;
</script>

</body>
</html>
