<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>××¢×¨×›×ª ×œ×•×– ×¨×›×‘×™× ××©×¤×—×ª×™×ª</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .dashboard {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 100%;
            max-width: 1000px;
            margin: 30px 0;
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
            overflow-x: auto;
        }

        .form {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .form input,
        .form select {
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .form button {
            background: #4facfe;
            color: white;
            border: none;
            padding: 10px 18px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            font-size: 16px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        th {
            background: #f0f0f0;
            font-weight: 600;
        }

        .save {
            width: 100%;
            padding: 14px;
            font-size: 18px;
            background: #00c853;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .admin {
            margin-top: 15px;
            width: 100%;
            padding: 14px;
            font-size: 18px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        #weeklySystem {
            margin-top: 30px;
            overflow-x: auto;
        }

        .system-table {
            border-collapse: collapse;
            width: 100%;
            max-width: 1000px;
            font-size: 16px;
        }

        .system-table th,
        .system-table td {
            border: 1px solid #333;
            padding: 14px;
            min-width: 150px;
            text-align: center;
            white-space: nowrap;
        }

        .system-table th {
            background: #bbdefb;
            font-weight: 700;
            font-size: 18px;
        }

        .time-cell {
            background: #eeeeee;
            font-weight: bold;
        }

        .editable {
            cursor: text;
            background: #fafafa;
        }

        .editable.editing {
            background: #fff9c4;
            outline: 2px solid #ffeb3b;
        }
    </style>
</head>
<body>

<div class="dashboard">
    <h1 id="welcome"></h1>
    <h2>×”×œ×•×´×– ×”×©×‘×•×¢×™ ×©×œ×™</h2>

    <div class="form">
        <select id="day">
            <option value="">×‘×—×¨ ×™×•×</option>
            <option value="×¨××©×•×Ÿ">×¨××©×•×Ÿ</option>
            <option value="×©× ×™">×©× ×™</option>
            <option value="×©×œ×™×©×™">×©×œ×™×©×™</option>
            <option value="×¨×‘×™×¢×™">×¨×‘×™×¢×™</option>
            <option value="×—××™×©×™">×—××™×©×™</option>
            <option value="×©×™×©×™">×©×™×©×™</option>
            <option value="×©×‘×ª">×©×‘×ª</option>
        </select>

        <input type="time" id="start">
        <input type="time" id="end">
        <input type="text" id="activity" placeholder="××” ×”×¤×¢×™×œ×•×ª?">

        <button onclick="addActivity()">â• ×”×•×¡×£</button>
    </div>

    <table>
        <thead>
          <tr>
            <th>×™×•×</th>
            <th>×”×ª×—×œ×”</th>
            <th>×¡×™×•×</th>
            <th>×¤×¢×™×œ×•×ª</th>
            <th>××—×™×§×”</th>
         </tr>
    </thead>

        <tbody id="tableBody"></tbody>
    </table>

    <button class="save" onclick="saveSchedule()">ğŸ’¾ ×©××™×¨×”</button>

    <button id="adminBtn" class="admin" onclick="generateWeeklyTableFinal()">
        ğŸ›  ×™×¦×™×¨×ª ××¢×¨×›×ª ×©×‘×•×¢×™×ª
    </button>

    <div id="weeklySystem" style="display:none;">
        <h2>××¢×¨×›×ª ×¨×›×‘×™× ×©×‘×•×¢×™×ª</h2>
        <div class="table-wrapper">
            <div id="systemTable"></div>
        </div>
    </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC9PTX8tvzhUf1BXW5ZeNbeKJcSF91sNjU",
  authDomain: "family-cars-scheduler.firebaseapp.com",
  databaseURL: "https://family-cars-scheduler-default-rtdb.firebaseio.com",
  projectId: "family-cars-scheduler",
  storageBucket: "family-cars-scheduler.firebasestorage.app",
  messagingSenderId: "646138637773",
  appId: "1:646138637773:web:12932dc39f54c0b803e884"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ---------------- Setup ×”××©×ª××© ----------------
let username = prompt("×”×›× ×¡ ×©× ××©×ª××©: ×××, ××™×ª×™, ×©× ×™, ××•×¨×™, ××‘×") || "××™×ª×™";
document.getElementById("welcome").textContent = `×©×œ×•× ${username} ğŸ‘‹`;

if (username !== "××™×ª×™") {
    document.getElementById("adminBtn").style.display = "none";
}

let activities = [];
const daysOrder = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
const cars = ["×××–×“×” ×œ×‘× ×”","×××–×“×” ×›×—×•×œ×”","×˜×•×™×•×˜×” (××‘×)","××•×˜×•×‘×•×¡"];

// ---------------- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ----------------
const dayInput = (v) => { const el = document.getElementById("day"); if(v!==undefined) el.value=v; return el.value; };
const startInput = (v) => { const el = document.getElementById("start"); if(v!==undefined) el.value=v; return el.value; };
const endInput = (v) => { const el = document.getElementById("end"); if(v!==undefined) el.value=v; return el.value; };
const activityInput = (v) => { const el = document.getElementById("activity"); if(v!==undefined) el.value=v; return el.value; };

function clearForm() {
    document.getElementById("day").value = "";
    document.getElementById("start").value = "";
    document.getElementById("end").value = "";
    document.getElementById("activity").value = "";
}

// ---------------- ×œ×•×– ××™×©×™ ----------------
function addActivity() {
    const day = dayInput();
    const start = startInput();
    const end = endInput();
    const activity = activityInput();

    if (!day || !start || !end || !activity) {
        alert("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª");
        return;
    }

    activities.push({ username, day, start, end, activity });
    sortActivities();
    renderTable();
    clearForm();
}

function sortActivities() {
    activities.sort((a,b) =>
        daysOrder.indexOf(a.day) - daysOrder.indexOf(b.day) ||
        a.start.localeCompare(b.start)
    );
}

function renderTable() {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    activities.forEach((a,index)=>{
        tbody.innerHTML += `
        <tr>
            <td>${a.day}</td>
            <td>${a.start}</td>
            <td>${a.end}</td>
            <td>${a.activity}</td>
            <td><button onclick="deleteActivity(${index})">âŒ</button></td>
        </tr>
        `;
    });
}

function deleteActivity(index) {
    if(!confirm("×œ××—×•×§ ××ª ×”×¤×¢×™×œ×•×ª?")) return;
    activities.splice(index,1);
    renderTable();
}

// ---------------- Firebase Functions ----------------
function saveSchedule() {
    const userRef = ref(db, `schedules/${username}`);
    set(userRef, activities)
        .then(()=>alert("×”×œ×•×´×– × ×©××¨ ×‘×”×¦×œ×—×” âœ…"))
        .catch(()=>alert("×©×’×™××” ×‘×©××™×¨×ª ×”×œ×•×´×– âŒ"));
}

function loadUserSchedule() {
    const userRef = ref(db, `schedules/${username}`);
    get(userRef).then(snapshot=>{
        activities = snapshot.val() || [];
        sortActivities();
        renderTable();
    });
}

// ×˜×¢×™× ×ª ×œ×•×– ×”××©×ª××© ×›×©×¤×•×ª×—×™× ××ª ×”×“×£
loadUserSchedule();

// ×˜×¢×™× ×ª ×›×œ ×œ×•×–×™×
async function loadAllSchedules() {
    const snapshot = await get(ref(db,"schedules"));
    if(!snapshot.exists()) return [];
    const data = snapshot.val();
    return Object.values(data).flat();
}

// ---------------- ××¢×¨×›×ª ×©×‘×•×¢×™×ª ----------------
function enableEditing() {
    document.querySelectorAll(".editable").forEach(cell => {
        cell.addEventListener("focus", () => cell.classList.add("editing"));
        cell.addEventListener("blur", () => cell.classList.remove("editing"));
    });
}

async function generateWeeklyTableFinal() {
    const personalSchedules = await loadAllSchedules();
    document.getElementById("weeklySystem").style.display = "block";

    let html = `<table class="system-table">`;
    html += `<tr><th>×™×•×</th><th>×©×¢×•×ª</th>`;
    cars.forEach(car => html += `<th>${car}</th>`);
    html += `</tr>`;

    for(let day of daysOrder){
        const requests = personalSchedules.filter(r => r.day===day);
        if(!requests.length) continue;

        let intervals = [];
        requests.forEach(r=>{
            let added = false;
            for(let interval of intervals){
                if(!(r.end <= interval.start || r.start >= interval.end)){
                    interval.start = r.start < interval.start ? r.start : interval.start;
                    interval.end = r.end > interval.end ? r.end : interval.end;
                    interval.requests.push(r);
                    added = true;
                    break;
                }
            }
            if(!added) intervals.push({start:r.start,end:r.end,requests:[r]});
        });

        intervals.forEach((interval,idx)=>{
            html += `<tr>`;
            if(idx===0) html += `<td class="time-cell" rowspan="${intervals.length}">${day}</td>`;
            html += `<td class="time-cell">${interval.start}-${interval.end}</td>`;

            const assigned = {};
            const assignedUsers = new Set();

            const bluePriority = ["×××","××™×ª×™","××•×¨×™"];
            const blueUser = bluePriority.find(u=>interval.requests.some(r=>r.username===u) && !assignedUsers.has(u));
            assigned["×××–×“×” ×›×—×•×œ×”"] = blueUser ? [blueUser] : [];
            if(blueUser) assignedUsers.add(blueUser);

            let whiteUser=null;
            const itiAssignedBlue = assignedUsers.has("××™×ª×™");
            const shani = interval.requests.find(r=>r.username==="×©× ×™");
            const iti = interval.requests.find(r=>r.username==="××™×ª×™");

            if(shani){
                if(itiAssignedBlue) whiteUser="×©× ×™";
                else{
                    const shaniImportant=["×¢×‘×•×“×”","×œ×™××•×“×™×"].some(act=>shani.activity.toLowerCase().includes(act));
                    const itiImportant = iti ? ["×¢×‘×•×“×”","×œ×™××•×“×™×"].some(act=>iti.activity.toLowerCase().includes(act)) : false;
                    if(shaniImportant || (!shaniImportant && !itiImportant)) whiteUser="×©× ×™";
                    else if(itiImportant) whiteUser="××™×ª×™";
                }
            } else if(iti) whiteUser="××™×ª×™";

            if(whiteUser){ assigned["×××–×“×” ×œ×‘× ×”"]=[whiteUser]; assignedUsers.add(whiteUser);}
            else assigned["×××–×“×” ×œ×‘× ×”"]=[];

            if(interval.requests.some(r=>r.username==="××‘×") && !assignedUsers.has("××‘×")){
                assigned["×˜×•×™×•×˜×” (××‘×)"]=["××‘×"];
                assignedUsers.add("××‘×");
            } else assigned["×˜×•×™×•×˜×” (××‘×)"]=[];

            assigned["××•×˜×•×‘×•×¡"]=interval.requests.map(r=>r.username).filter(u=>!assignedUsers.has(u));

            cars.forEach(car=>html+=`<td class="editable" contenteditable="true">${assigned[car].join(", ")}</td>`);

            html+=`</tr>`;
        });
    }

    html+=`</table>`;
    document.getElementById("systemTable").innerHTML=html;
    enableEditing();
}

// ---------------- exposed globally ----------------
window.addActivity = addActivity;
window.deleteActivity = deleteActivity;
window.saveSchedule = saveSchedule;
window.generateWeeklyTableFinal = generateWeeklyTableFinal;
</script>

</body>
</html>

