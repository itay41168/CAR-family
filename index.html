<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>×¡×™×“×•×¨ ×¨×›×‘×™× ××©×¤×—×ª×™ - Firebase</title>
<style>
/* ×‘×¡×™×¡ ×•×¢×™×¦×•×‘ */
body { font-family: Arial, sans-serif; background:#f0f2f5; margin:0; padding:18px; color:#111; }
h1,h2,h3 { text-align:center; margin:10px 0; }
.container { max-width:1000px; margin:auto; padding:18px; }
.card { background:#fff; padding:18px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08); margin-bottom:18px; }
button { padding:12px 24px; margin:8px; border:none; border-radius:8px; background:#2f7d32; color:white; cursor:pointer; font-size:1em; }
button.secondary { background:#1976d2; }
button.danger { background:#c62828; }
button:disabled { opacity:0.6; cursor:not-allowed; }
input, select, textarea { padding:10px; border-radius:8px; border:1px solid #ccd; font-size:1em; }
input, textarea { width:100%; max-width:420px; box-sizing:border-box; }
label { display:inline-block; margin:8px 0; font-weight:600; }
table { border-collapse:collapse; width:100%; margin:14px 0; table-layout:fixed; word-wrap:break-word; background:#fff; }
th, td { border:1px solid #e6e6e6; padding:10px; text-align:center; font-size:1em; }
th { background:#fafafa; font-weight:700; }
.hidden { display:none !important; }
.table-wrapper { overflow-x:auto; }

/* ×¨×¡×¤×•× ×¡×™×‘×™×•×ª */
@media (max-width:768px) {
  body { font-size:1.15em; }
  button { padding:14px 26px; margin:6px; font-size:1.05em; }
  input, textarea { font-size:1.05em; }
  th,td { font-size:1.05em; padding:10px; }
}
@media (max-width:480px) {
  body { font-size:1.25em; }
  button { padding:16px 30px; font-size:1.15em; margin:6px 4px; }
  input, textarea { font-size:1.15em; }
  h1,h2,h3 { font-size:1.35em; }
}
.note { color:#666; font-size:0.95em; margin-top:8px; }
</style>
</head>
<body>
<div class="container">
  <h1>×¡×™×“×•×¨ ×¨×›×‘×™× ××©×¤×—×ª×™</h1>

  <!-- ×“×£ 1: ×›× ×™×¡×” -->
  <div id="loginPage" class="card">
    <h2>×›× ×™×¡×”</h2>
    <label for="loginId">×ª×¢×•×“×ª ×–×”×•×ª (ID):</label>
    <input id="loginId" type="text" placeholder="×œ××©×œ: 001 ××• 207933169" />
    <div style="margin-top:12px;">
      <button onclick="login()">×”×ª×—×‘×¨</button>
    </div>
    <p class="note">×“×•×’××” IDs/××©×ª××©×™× ××•×‘× ×™× ×‘××¢×¨×›×ª â€” ×¢×¨×•×š ×‘×§×•×‘×¥ ×‘×§×•×“</p>
  </div>

  <!-- ×“×£ 2: ×¢×¨×™×›×” -->
  <div id="editPage" class="card hidden">
    <h2>×¢×¨×™×›×ª ××©××¨×•×ª ×•×”×¢×“×¤×•×ª</h2>
    <div id="userNameDisplay" style="font-weight:700; margin-bottom:8px;"></div>

    <div class="table-wrapper">
      <table id="requestTable">
        <tr><th>×™×•×</th><th>××©××¨×ª</th><th>×¢×“×™×¤×•×ª</th></tr>
      </table>
    </div>

    <label for="notes">×”×¢×¨×•×ª / ×‘×§×©×•×ª ×”×¡×¢×”:</label>
    <textarea id="notes" rows="4" placeholder="×œ××©×œ: ×¦×¨×™×š ×”×¡×¢×” ×‘×™×•× ×¨××©×•×Ÿ ×‘×‘×•×§×¨"></textarea>

    <div style="text-align:center; margin-top:12px;">
      <button id="saveBtn" class="secondary" onclick="saveRequest()">×©××•×¨</button>
      <button id="resetBtn" class="danger" onclick="resetAllRequests()">××¤×¡ ×”×›×œ (×× ×”×œ)</button>
      <button id="generateBtn" onclick="goToSchedule()">×¦×•×¨ ××¢×¨×›×ª (×× ×”×œ)</button>
      <button onclick="logout()">×”×ª× ×ª×§</button>
    </div>
    <p class="note">×”×©×™× ×•×™×™× × ×©××¨×™× ×‘×¢× ×Ÿ ×•××•×¤×™×¢×™× ××•×˜×•××˜×™×ª ××¦×œ ×›×œ ×”××›×©×™×¨×™×.</p>
  </div>

  <!-- ×“×£ 3: ××¢×¨×›×ª -->
  <div id="schedulePage" class="card hidden">
    <h2>××¢×¨×›×ª ×©×‘×•×¢×™×ª</h2>
    <div id="scheduleResult"></div>
    <div style="text-align:center; margin-top:12px;">
      <button onclick="backToEdit()">×—×–×•×¨ ×œ×¢×¨×™×›×”</button>
      <button onclick="logout()">×”×ª× ×ª×§</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

// ğŸ”¹ ×”×“×‘×§ ×›××Ÿ ××ª Firebase config ×©×œ×š
const firebaseConfig = {
  apiKey: "AIzaSyC9PTX8tvzhUf1BXW5ZeNbeKJcSF91sNjU",
  authDomain: "family-cars-scheduler.firebaseapp.com",
  databaseURL: "https://family-cars-scheduler-default-rtdb.firebaseio.com",
  projectId: "family-cars-scheduler",
  storageBucket: "family-cars-scheduler.firebasestorage.app",
  messagingSenderId: "646138637773",
  appId: "1:646138637773:web:12932dc39f54c0b803e884"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ×”×’×“×¨×•×ª ×‘×¡×™×¡×™×•×ª
const days = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
const shifts = ["08-16","16-00"];
const usersById = { "001":"××™×ª×™", "002":"×××", "003":"×©× ×™", "004":"×™×¦×—×§", "005":"××•×¨×™" };
const carPermissions = { "×˜×•×™×•×˜×”":["×™×¦×—×§"], "×××–×“×” 6":["×©× ×™","××™×ª×™","××•×¨×™"], "×××–×“×” 2":["×××","××™×ª×™"] };
const busAllowed = ["×©× ×™","××™×ª×™"];
const admins = ["××™×ª×™"];

let currentUser = null;
let currentUserId = null;
let localCache = {};

// ×›×œ×™×
const qs = s => document.querySelector(s);
const show = s => qs(s).classList.remove("hidden");
const hide = s => qs(s).classList.add("hidden");

// ×‘×•× ×” ×˜×‘×œ×” ×•××©××¨×•×ª
function initTable(){
  const tbl = qs("#requestTable");
  tbl.innerHTML = "<tr><th>×™×•×</th><th>××©××¨×ª</th><th>×¢×“×™×¤×•×ª</th></tr>";
  for(const day of days){
    for(const shift of shifts){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${day}</td><td>${shift}</td>
        <td>
          <select>
            <option value="0">0 - ×œ× ×¦×¨×™×š ×¨×›×‘</option>
            <option value="1">1 - ×¨×›×‘ ×œ×‘×™×œ×•×™</option>
            <option value="2">2 - ×¢×‘×•×“×”/×œ×™××•×“×™×</option>
          </select>
        </td>`;
      tbl.appendChild(tr);
    }
  }
  enableAutoSave();
}

// ×©××™×¨×” ××•×˜×•××˜×™×ª
function enableAutoSave() {
  document.querySelectorAll("#requestTable select").forEach(sel=>{
    sel.addEventListener("change", saveRequest);
  });
  qs("#notes").addEventListener("input", saveRequest);
}

// ××œ× ×˜×‘×œ×” ×¢× × ×ª×•× ×™×
function populateTableFromData(data){
  const rows = qs("#requestTable").querySelectorAll("tr");
  let idx=0;
  rows.forEach((row,i)=>{
    if(i===0) return;
    const day=days[Math.floor(idx/2)];
    const shift=shifts[idx%2];
    const pr = data?.[day]?.[shift]?.priority ?? 0;
    row.cells[2].querySelector("select").value = pr;
    idx++;
  });
  qs("#notes").value = data?.notes ?? "";
}

// ×©××™×¨×” ×œ-Firebase
async function saveRequest(){
  if(!currentUser) return alert("××™×Ÿ ××©×ª××© ×¤×¢×™×œ");
  const rows = qs("#requestTable").querySelectorAll("tr");
  const payload = {};
  let idx=0;
  rows.forEach((row,i)=>{
    if(i===0) return;
    const day=days[Math.floor(idx/2)];
    const shift=shifts[idx%2];
    const priority=parseInt(row.cells[2].querySelector("select").value,10);
    if(!payload[day]) payload[day]={};
    payload[day][shift]={priority};
    idx++;
  });
  payload.notes = qs("#notes").value || "";
  payload.updatedAt = Date.now();
  await set(ref(db,"requests/"+currentUser),payload);
}

// ××™×¤×•×¡ ×× ×”×œ
async function resetAllRequests(){
  if(!admins.includes(currentUser)) return alert("×¨×§ ×× ×”×œ ×™×›×•×œ ×œ××¤×¡");
  if(!confirm("×œ×”××©×™×š ×•×œ××¤×¡ ××ª ×›×œ ×”×‘×—×™×¨×•×ª ×©×œ ×›×•×œ×?")) return;
  const zeros = {};
  for(const d of days){ zeros[d]={}; for(const s of shifts){ zeros[d][s]={priority:0}; } }
  zeros.notes=""; zeros.updatedAt=Date.now();
  const updates={};
  Object.values(usersById).forEach(name=>{ updates['requests/'+name]=zeros; });
  await update(ref(db),updates);
  alert("×›×œ ×”×‘×—×™×¨×•×ª ××•×¤×¡×• ×‘×¢× ×Ÿ");
}

// ×˜×¢×™× ×” ×¨××©×•× ×™×ª
async function initialLoadAll(){
  const snap = await get(ref(db,"requests"));
  localCache = snap.exists()?snap.val():{};
}

// ×××–×™×Ÿ ×‘×–××Ÿ ×××ª
onValue(ref(db,"requests"),snapshot=>{
  localCache = snapshot.exists()?snapshot.val():{};
  if(currentUser && !qs("#editPage").classList.contains("hidden")){
    populateTableFromData(localCache[currentUser]||null);
  }
});

// ×™×¦×™×¨×ª ××¢×¨×›×ª ×—×›××”
async function generateSchedule(){
  if(!localCache || Object.keys(localCache).length===0) await initialLoadAll();
  const requestsAll = localCache||{};
  const schedule = {}; const carUsageCount={};

  for(const d of days){
    schedule[d]={};
    for(const sh of shifts){
      schedule[d][sh]={"×˜×•×™×•×˜×”":null,"×××–×“×” 6":null,"×××–×“×” 2":null,"××•×˜×•×‘×•×¡":[]};
      const assigned={};
      schedule[d][sh]["×˜×•×™×•×˜×”"]="×™×¦×—×§"; assigned["×™×¦×—×§"]=true;

      ["×××–×“×” 6","×××–×“×” 2"].forEach(car=>{
        const candidates=[];
        for(const person in requestsAll){
          const pr=requestsAll[person]?.[d]?.[sh]?.priority ??0;
          if(pr>0 && !assigned[person] && (carPermissions[car]||[]).includes(person)){
            candidates.push({name:person,pr});
          }
        }
        if(candidates.length===0) return;
        candidates.sort((a,b)=> b.pr!==a.pr? b.pr-a.pr: (carUsageCount[a.name]||0)-(carUsageCount[b.name]||0));
        const chosen=candidates[0].name;
        schedule[d][sh][car]=chosen; assigned[chosen]=true;
        carUsageCount[chosen]=(carUsageCount[chosen]||0)+1;
      });

      for(const person in requestsAll){
        const pr=requestsAll[person]?.[d]?.[sh]?.priority ??0;
        if(pr>0 && !assigned[person] && busAllowed.includes(person)){
          schedule[d][sh]["××•×˜×•×‘×•×¡"].push(person); assigned[person]=true;
        }
      }
    }
  }

  let html="<div class='table-wrapper'><table>";
  html+="<tr><th>×™×•×</th><th>××©××¨×ª</th><th>×˜×•×™×•×˜×”</th><th>×××–×“×” 6</th><th>×××–×“×” 2</th><th>××•×˜×•×‘×•×¡</th></tr>";
  for(const d of days){
    for(const sh of shifts){
      html+=`<tr><td>${d}</td><td>${sh}</td>
        <td>${schedule[d][sh]["×˜×•×™×•×˜×”"]||""}</td>
        <td>${schedule[d][sh]["×××–×“×” 6"]||""}</td>
        <td>${schedule[d][sh]["×××–×“×” 2"]||""}</td>
        <td>${(schedule[d][sh]["××•×˜×•×‘×•×¡"]||[]).join(", ")}</td>
      </tr>`;
    }
  }
  html+="</table></div>";
  html+="<h3>×”×¢×¨×•×ª:</h3><ul>";
  for(const person in requestsAll){
    const note=(requestsAll[person]?.notes||"").trim();
    if(note) html+=`<li>* ${person}: ${note}</li>`;
  }
  html+="</ul>";
  qs("#scheduleResult").innerHTML=html;
}

// ×–×¨×™××ª ××¡×›×™×
window.login=async function(){
  const id=qs("#loginId").value.trim();
  if(!id) return alert("×”×›× ×¡ ID");
  if(!usersById[id]) return alert("ID ×œ× ××•×›×¨");
  currentUserId=id; currentUser=usersById[id];

  hide("#loginPage"); show("#editPage");
  qs("#userNameDisplay").innerText="×©×œ×•×, "+currentUser;

  initTable();
  const snap=await get(ref(db,"requests/"+currentUser));
  const data = snap.exists()?snap.val():null;
  if(data) localCache[currentUser]=data;
  populateTableFromData(data);
  updateAdminAccess();
};

window.logout=function(){
  currentUser=null; currentUserId=null;
  show("#loginPage"); hide("#editPage"); hide("#schedulePage");
  qs("#requestTable").innerHTML="<tr><th>×™×•×</th><th>××©××¨×ª</th><th>×¢×“×™×¤×•×ª</th></tr>";
  qs("#notes").value="";
};

function updateAdminAccess(){
  const isAdmin = admins.includes(currentUser);
  qs("#resetBtn").style.display = isAdmin?"inline-block":"none";
  qs("#generateBtn").style.display = isAdmin?"inline-block":"none";
}

window.saveRequest=saveRequest;
window.resetAllRequests=resetAllRequests;

window.goToSchedule=async function(){ await generateSchedule(); hide("#editPage"); show("#schedulePage"); };
window.backToEdit=function(){ hide("#schedulePage"); show("#editPage"); };

initialLoadAll().catch(()=>{});
</script>
</body>
</html>
