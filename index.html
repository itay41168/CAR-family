<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>××¢×¨×›×ª ×œ×•×– ×¨×›×‘×™× ××©×¤×—×ª×™×ª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg,#4facfe,#00f2fe);
    margin:0;
    padding:10px;
}
.dashboard {
    background:#fff;
    border-radius:16px;
    padding:20px;
    max-width:1100px;
    margin:auto;
}
.form {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
}
.form input,.form select,.form button {
    padding:10px;
    font-size:14px;
}
table {
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
}
th,td {
    border:1px solid #ccc;
    padding:8px;
    text-align:center;
}
th { background:#f0f0f0 }
.save,.admin {
    width:100%;
    padding:12px;
    margin-top:10px;
    font-size:16px;
    border:none;
    color:white;
}
.save { background:#00c853 }
.admin { background:#ff9800 }
.system-table th { background:#bbdefb }
.time-cell { background:#eee;font-weight:bold }
.editable { background:#fafafa; cursor:text }
.editable.editing { outline:2px solid #ff9800 }
</style>
</head>

<body>
<div class="dashboard">

<h2 id="welcome"></h2>

<div class="form">
<select id="day">
<option value="">×‘×—×¨ ×™×•×</option>
<option>×¨××©×•×Ÿ</option><option>×©× ×™</option><option>×©×œ×™×©×™</option>
<option>×¨×‘×™×¢×™</option><option>×—××™×©×™</option><option>×©×™×©×™</option><option>×©×‘×ª</option>
</select>

<input id="start" placeholder="×©×¢×ª ×”×ª×—×œ×”">
<input id="end" placeholder="×©×¢×ª ×¡×™×•×">
<input id="activity" placeholder="×”×©×™××•×©">
<button onclick="addActivity()">â• ×”×•×¡×£</button>
</div>

<table>
<thead>
<tr>
<th>×™×•×</th><th>×”×ª×—×œ×”</th><th>×¡×™×•×</th><th>×¤×¢×™×œ×•×ª</th><th></th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<button class="save" onclick="saveSchedule()">ğŸ’¾ ×©××™×¨×ª ×œ×•×– ××™×©×™</button>
<button class="admin" id="adminBtn" onclick="generateWeeklyTableFinal()">ğŸ›  ×™×¦×™×¨×ª ××¢×¨×›×ª ×©×‘×•×¢×™×ª</button>

<div id="weeklySystem" style="margin-top:20px">
<div id="systemTable"></div>
</div>

</div>


<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* ---------- Firebase ---------- */
const app = initializeApp({
  apiKey: "AIzaSyC9PTX8tvzhUf1BXW5ZeNbeKJcSF91sNjU",
  databaseURL: "https://family-cars-scheduler-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);

/* ---------- ××©×ª××© ---------- */
let username = prompt("×”×›× ×¡ ×©× ××©×ª××©: ×××, ××™×ª×™, ×©× ×™, ××•×¨×™, ××‘×") || "××™×ª×™";
welcome.textContent = `×©×œ×•× ${username} ğŸ‘‹`;
if(username !== "××™×ª×™") adminBtn.style.display="none";

/* ---------- ×§×‘×•×¢×™× ---------- */
const daysOrder=["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
const cars=["×××–×“×” ×œ×‘× ×”","×××–×“×” ×›×—×•×œ×”","×˜×•×™×•×˜×” (××‘×)","××•×˜×•×‘×•×¡"];
let activities=[];

flatpickr("#start", {
    enableTime: true,
    noCalendar: true,
    dateFormat: "H:i",
    time_24hr: true,
    minuteIncrement: 5,
    allowInput: true,
    onOpen: function(selectedDates, dateStr, instance) {
        if (!instance.input.value) instance.input.placeholder = "×©×¢×ª ×”×ª×—×œ×”";
    },
    onClose: function(selectedDates, dateStr, instance) {
        if (!instance.input.value) instance.input.placeholder = "×©×¢×ª ×”×ª×—×œ×”";
    }
});

flatpickr("#end", {
    enableTime: true,
    noCalendar: true,
    dateFormat: "H:i",
    time_24hr: true,
    minuteIncrement: 5,
    allowInput: true,
    onOpen: function(selectedDates, dateStr, instance) {
        if (!instance.input.value) instance.input.placeholder = "×©×¢×ª ×¡×™×•×";
    },
    onClose: function(selectedDates, dateStr, instance) {
        if (!instance.input.value) instance.input.placeholder = "×©×¢×ª ×¡×™×•×";
    }
});


/* ---------- ×¢×–×¨ ---------- */
const toMin=t=>{const[a,b]=t.split(":").map(Number);return a*60+b};

/* ---------- ×œ×•×– ××™×©×™ ---------- */
function addActivity(){
  const d=day.value,s=start.value,e=end.value,a=activity.value;
  if(!d||!s||!e||!a) return alert("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª");
  if(toMin(s)>=toMin(e)) return alert("×©×¢×ª ×”×ª×—×œ×” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤× ×™ ×©×¢×ª ×¡×™×•×");

  const overlap=activities.some(x=>
    x.day===d && !(toMin(e)<=toMin(x.start)||toMin(s)>=toMin(x.end))
  );
  if(overlap) return alert("âŒ ×™×© ×—×¤×™×¤×” ×¢× ×¤×¢×™×œ×•×ª ×§×™×™××ª");

  activities.push({username,day:d,start:s,end:e,activity:a});
  render(); clearForm();
}

function render() {
  // ××™×•×Ÿ ×”×¤×¢×™×œ×•×™×•×ª
  activities.sort((a, b) =>
    daysOrder.indexOf(a.day) - daysOrder.indexOf(b.day) ||
    a.start.localeCompare(b.start)
  );

  // × ×™×§×•×™ ×”×˜×‘×œ×”
  tableBody.innerHTML = "";

  // ×§×‘×•×¦×” ×œ×¤×™ ×™×•×
  const activitiesByDay = {};
  activities.forEach(a => {
    if (!activitiesByDay[a.day]) activitiesByDay[a.day] = [];
    activitiesByDay[a.day].push(a);
  });

  // ×‘× ×™×™×ª ×”×˜×‘×œ×”
  for (const day of daysOrder) {
    const dayActivities = activitiesByDay[day];
    if (!dayActivities) continue;

    dayActivities.forEach((act, idx) => {
      tableBody.innerHTML += `
        <tr>
          ${idx === 0 ? `<td rowspan="${dayActivities.length}">${day}</td>` : ""}
          <td>${act.start}</td>
          <td>${act.end}</td>
          <td>${act.activity}</td>
          <td><button onclick="deleteActivity(${activities.indexOf(act)})">âŒ</button></td>
        </tr>
      `;
    });
  }
}


function deleteActivity(i){ activities.splice(i,1); render(); }
function clearForm(){ day.value=start.value=end.value=activity.value=""; }

/* ---------- Firebase ---------- */
function saveSchedule(){
  set(ref(db,"schedules/"+username),activities)
    .then(()=>alert("× ×©××¨ ×‘×”×¦×œ×—×”"));
}

async function loadUserSchedule(){
  const snap=await get(ref(db,"schedules/"+username));
  activities=snap.val()||[];
  render();
}
loadUserSchedule();

async function loadAllSchedules(){
  const snap=await get(ref(db,"schedules"));
  if(!snap.exists()) return [];
  return Object.values(snap.val()).flat();
}

/* ---------- ××¢×¨×›×ª ×©×‘×•×¢×™×ª ---------- */
function enableEditing(){
  document.querySelectorAll(".editable").forEach(c=>{
    c.addEventListener("focus",()=>c.classList.add("editing"));
    c.addEventListener("blur",()=>c.classList.remove("editing"));
  });
}

async function generateWeeklyTableFinal() {
  const personalSchedules = await loadAllSchedules();
  weeklySystem.style.display = "block";

  let html = `<table class="system-table">
    <tr>
      <th>×™×•×</th>
      <th>×©×¢×•×ª</th>`;
  cars.forEach(c => html += `<th>${c}</th>`);
  html += `</tr>`;

  for (const day of daysOrder) {
    const requests = personalSchedules
      .filter(r => r.day === day)
      .sort((a,b) => a.start.localeCompare(b.start));

    if (!requests.length) continue;

    /* ---------- ×™×¦×™×¨×ª intervals ×—×›××™× ---------- */
    const events = [];
    requests.forEach(r => {
      events.push({ time: r.start, type: "start", request: r });
      events.push({ time: r.end,   type: "end",   request: r });
    });
    events.sort((a,b) => a.time.localeCompare(b.time) || (a.type==="start"? -1:1));


    const MAX_OVERLAP_MINUTES = 200; // ×©×¢×ª×™×™×

let intervals = [];
let active = new Set();
let lastTime = null;

for (const ev of events) {
  if (lastTime !== null && lastTime !== ev.time && active.size > 0) {

    // ×¨×§ ××™×—×•×“ ×©×œ ×¢×“ ×©×ª×™ ×‘×§×©×•×ª
    if (active.size <= 2) {
      const lastInterval = intervals[intervals.length - 1];

      // ×‘×“×™×§×”: ×™×© ××™× ×˜×¨×•×•×œ ×§×•×“×, ××¡×¤×¨ ×‘×§×©×•×ª <=2 ×•×”×¤×¨×© ×œ× ×’×“×•×œ ××“×™
      if (
        lastInterval &&
        lastInterval.requests.length <= 2 &&
        lastInterval.end === lastTime &&
        (toMin(ev.time) - toMin(lastInterval.start)) <= MAX_OVERLAP_MINUTES
      ) {
        // ×××—×“ ×¢× ×”×§×•×“×
        lastInterval.end = ev.time;
        active.forEach(r => {
          if (!lastInterval.requests.includes(r)) lastInterval.requests.push(r);
        });
      } else {
        // ××™× ×˜×¨×•×•×œ ×—×“×©
        intervals.push({ start: lastTime, end: ev.time, requests: Array.from(active) });
      }

    } else {
      // ×× ×™×•×ª×¨ ××©×ª×™ ×‘×§×©×•×ª â€“ ×ª××™×“ ××™× ×˜×¨×•×•×œ ×—×“×©
      intervals.push({ start: lastTime, end: ev.time, requests: Array.from(active) });
    }
  }

  if (ev.type === "start") active.add(ev.request);
  else active.delete(ev.request);

  lastTime = ev.time;
}


    /* ---------- ×™×¦×™×¨×ª ×”×˜×‘×œ×” ---------- */
    intervals.forEach((intv, idx) => {
      html += `<tr>`;
      if (idx === 0) html += `<td rowspan="${intervals.length}" class="time-cell">${day}</td>`;
      html += `<td class="time-cell">${intv.start}-${intv.end}</td>`;

      const users = [...new Set(intv.requests.map(r => r.username))];
      const used = new Set();
      const assigned = {};

      /* ---------- ×××–×“×” ×›×—×•×œ×” ---------- */
      const bluePriority = ["×××","××™×ª×™","××•×¨×™"];
      const blue = bluePriority.find(u => users.includes(u) && !used.has(u));
      assigned["×××–×“×” ×›×—×•×œ×”"] = blue ? [blue] : [];
      if (blue) used.add(blue);

      /* ---------- ×××–×“×” ×œ×‘× ×” ---------- */
      let white = null;
      const itiBlue = used.has("××™×ª×™");
      const shani = intv.requests.find(r=>r.username==="×©× ×™");
      const iti   = intv.requests.find(r=>r.username==="××™×ª×™");

      if (shani && !used.has("×©× ×™")) {
        if (itiBlue) white="×©× ×™";
        else {
          const sImp=["×¢×‘×•×“×”","×œ×™××•×“×™×"].some(x=>shani.activity.includes(x));
          const iImp=iti?["×¢×‘×•×“×”","×œ×™××•×“×™×"].some(x=>iti.activity.includes(x)):false;
          if(sImp||(!sImp&&!iImp)) white="×©× ×™";
          else if(iImp&&!used.has("××™×ª×™")) white="××™×ª×™";
        }
      } else if(iti && !used.has("××™×ª×™")) white="××™×ª×™";

      assigned["×××–×“×” ×œ×‘× ×”"] = white ? [white] : [];
      if(white) used.add(white);

      /* ---------- ×ª×™×§×•×Ÿ ×¡×•×¤×™: ×œ×”×¢×‘×™×¨ ××ª ××™×ª×™ ×œ×œ×‘×Ÿ ×× ×¤× ×•×™ ---------- */
      if (assigned["×××–×“×” ×›×—×•×œ×”"].includes("××™×ª×™") && assigned["×××–×“×” ×œ×‘× ×”"].length===0) {
        assigned["×××–×“×” ×›×—×•×œ×”"] = [];
        assigned["×××–×“×” ×œ×‘× ×”"] = ["××™×ª×™"];
      }

      /* ---------- ×˜×•×™×•×˜×” ××‘× ---------- */
      if(users.includes("××‘×") && !used.has("××‘×")) {
        assigned["×˜×•×™×•×˜×” (××‘×)"] = ["××‘×"];
        used.add("××‘×");
      } else assigned["×˜×•×™×•×˜×” (××‘×)"] = [];

      /* ---------- ××•×˜×•×‘×•×¡ ---------- */
      assigned["××•×˜×•×‘×•×¡"] = users.filter(u=>!used.has(u));

      /* ---------- ×”×“×¤×¡×” ---------- */
      cars.forEach(c=>html+=`<td class="editable" contenteditable="true">${assigned[c].join(", ")}</td>`);
      html += `</tr>`;
    });
  }

  html += `</table>`;
  systemTable.innerHTML = html;
  enableEditing();
}



/* ---------- ×’×œ×•×‘×œ×™ ---------- */
window.addActivity=addActivity;
window.deleteActivity=deleteActivity;
window.saveSchedule=saveSchedule;
window.generateWeeklyTableFinal=generateWeeklyTableFinal;
</script>
</body>
</html>

